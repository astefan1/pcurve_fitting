---
title: "Evaluation of p-curve simulation results"
author: "Felix Sch√∂nbrodt & Angelika Stefan"
date: today
execute:
  cache: true
format: 
  html:
    code-fold: true
    embed-resources: true

---


```{r}
#| include: false

# ==============================================================================
# Eval scenarios
# ==============================================================================

library(fitPCurve)
library(rio)
library(dplyr)
library(ggplot2)

# The working directory should be the project root
# if quarto:render is called
if (!interactive()) {
  print("Switching working directory to project root")
  setwd("..")
}

# reference p-curves
pcurves <- import("simulations/reference-pcurves.csv")

# load the multiple DV simulation results:
simres_realistic <- import("simulations/sim-results/sim_realistic.csv")
simres_realistic$condition <- "multDV_realistic"
simres_worst <- import("simulations/sim-results/sim_worst.csv")
simres_worst$condition <- "multDV_worst"
simres_perfect <- import("simulations/sim-results/sim_perfect.csv")
simres_perfect$condition <- "multDV_perfect"
simres_H0 <- import("simulations/sim-results/sim_H0.csv")
simres_H0$condition <- "multDV_H0"

# load the optional stopping simulation results:
simres_optStop_worst <- import("simulations/sim-results/sim_optStop_worst.csv")
simres_optStop_worst$condition <- "optStop_worst"
simres_optStop_realistic <- import("simulations/sim-results/sim_optStop_realistic.csv")
simres_optStop_realistic$condition <- "optStop_realistic"

simres_multDV <- rbind(simres_realistic, simres_worst, simres_perfect, simres_H0)
simres_multDV$binsum <- rowSums(simres_multDV[, paste0("p", 1:5)])
stopifnot(all(simres_multDV$binsum |> round(6) == 1))
simres_multDV$type <- "multDV"

simres_optStop <- rbind(simres_optStop_realistic, simres_optStop_worst)
simres_optStop$binsum <- rowSums(simres_optStop[, paste0("p", 1:5)])
stopifnot(all(simres_optStop$binsum |> round(6) == 1))
simres_optStop$type <- "optStop"

# combine simulations from both p-hacking strategies (they have different parameter columns)
simres <- bind_rows(simres_multDV, simres_optStop)

simres$rmseSotola     <- rmse(reference=simplify2array(pcurves[1, paste0("p", 1:5)]), comparison=simres[, paste0("p", 1:5)])
simres$rmseWetzels    <- rmse(reference=simplify2array(pcurves[2, paste0("p", 1:5)]), comparison=simres[, paste0("p", 1:5)])
simres$rmseSimonsohn  <- rmse(reference=simplify2array(pcurves[3, paste0("p", 1:5)]), comparison=simres[, paste0("p", 1:5)])

save(simres, file="simulations/sim-results/simres_all.RData")
save(simres, file="simulations/ShinyApp/simres_all.RData")

# Compute chi2 fit statistic

simres$chi2Sotola <- chi2(
  reference = simplify2array(pcurves[1, paste0("p", 1:5)]), 
  comparison = simres[, paste0("p", 1:5)], n = pcurves$nsig[1])

simres$chi2Wetzels <- chi2(
  reference = simplify2array(pcurves[2, paste0("p", 1:5)]), 
  comparison = simres[, paste0("p", 1:5)], n = pcurves$nsig[2])

simres$chi2Simonsohn <- chi2(
  reference = simplify2array(pcurves[3, paste0("p", 1:5)]), 
  comparison = simres[, paste0("p", 1:5)], n = pcurves$nsig[3])


# # A heatmap with all conditions of the multDV strategy (no averaging; each condition is one tile)
# ggplot(simres |> filter(type=="multDV"), aes(x = d, y = prop_H1, fill = rmseSimonsohn)) +
#   geom_tile() +
#   facet_grid(
#     rows = vars(het, nvar, strategy),      # two stacked facet rows
#     cols = vars(r, prop_Hacker)  # two stacked facet columns
#   ) +
#   scale_fill_viridis_c(
#     option = "inferno",
#     direction = -1,
#     values = c(0, 0.1, 1),
#     limits=c(
#       min(simres |> select(contains("rmse"))),
#       max(simres |> select(contains("rmse")))
#     )
#   ) +
#   scale_y_continuous(breaks = sort(unique(simres$r))) +
#   theme_minimal(base_size = 9) +
#   theme(
#     panel.spacing.x = unit(0.01, "lines"),
#     panel.spacing.y = unit(0.01, "lines")
#   )

# simres$prop_H1_factor <- as.factor(simres$prop_H1)
# ggplot(simres |> filter(condition=="multDV_realistic", strategy==1, r==0), aes(x = d, y = prop_H1_factor, fill = rmseSimonsohn)) +
#   geom_tile() +
#   facet_grid(
#     rows = vars(het, nvar, strategy),      # two stacked facet rows
#     cols = vars(r, prop_Hacker)  # two stacked facet columns
#   ) +
#   scale_fill_viridis_c(
#     option = "inferno",
#     direction = -1,
#     values = c(0, 0.1, 1),
#     limits=c(
#       min(simres |> select(contains("rmse"))),
#       max(simres |> select(contains("rmse")))
#     )
#   ) +
#   theme_minimal(base_size = 9) +
#   theme(
#     panel.spacing.x = unit(0.01, "lines"),
#     panel.spacing.y = unit(0.01, "lines")
#   )


#--------------------------------------------------------------------------------
# Some sanity checks

# Correlation between our two GOF measures (rmse and chi2)
cor(simres$rmseSotola, simres$chi2Sotola, use="p", method="spearman")
# plot(simres$rmseSotola, simres$chi2Sotola)
cor(simres$rmseWetzels, simres$chi2Wetzels, use="p", method="spearman")
cor(simres$rmseSimonsohn, simres$chi2Simonsohn, use="p", method="spearman")

```

In the following plots, always the RMSE goodness-of-fit measure is used (not chi2).

# Some synthetic p-curves: Testing specific scenarios

## Test a pure bump

### Multiple DVs
```{r}
#| echo: false

reference <- c(.15, .15, .15, .15, .40)
simres$rmseBump <- rmse(reference = reference, comparison = simres[, paste0("p", 1:5)])
plot_pcurves(simdat=simres |> filter(type == "multDV"), poriginal = reference, n_best = 10) + ggtitle("Multiple DVs")
```

::: {.callout-caution}
I thought, the multiDV cannot produce a bump? Is this still MC error, or is there a real bump?
:::

The best fitting scenarios from the "multiple DVs" simulations are:
```{r}
simres |> filter(type == "multDV") |> arrange(rmseBump) |> slice(1:5) |> select(c(1:9, 10:14), rmseBump) |> round(2) |> print()
```

### Optional Stopping
```{r}
# all optStop scenarios:
plot_pcurves(simres |> filter(type == "optStop"), poriginal = reference, n_best = 10) + ggtitle("Optional Stopping")
```

The best fitting scenarios from the "optional stopping" simulations are:
```{r}
simres |> filter(type == "optStop") |> arrange(rmseBump) |> slice(1:5) |> select(c(18:20, 10:14), rmseBump) |> round(2) |> print()
```

## Test a "true signal + bump" pattern

### Multiple DVs
```{r}
reference2 <- c(.40, .20, .10, .05, .25)
#reference <- c(.45, .22, .14, .05, .14)

# all multDV scenarios:
simres$rmseBump2 <- rmse(reference2, simres[, paste0("p", 1:5)])
plot_pcurves(simres |> filter(type == "multDV"), poriginal = reference2, n_best = 10, GOF="rmse")
```

The best fitting scenarios from the "multiple DVs" simulations are:
```{r}
simres |> filter(type == "multDV") |> arrange(rmseBump2) |> slice(1:5) |> select(c(1:9, 10:14), rmseBump2) |> round(2) |> print()
```

### Optional Stopping

```{r}
# all optStop scenarios:
plot_pcurves(simres |> filter(type == "optStop"), poriginal = reference2, n_best = 10, GOF="rmse")
```

The best fitting scenarios from the "optional stopping" simulations are:
```{r}
simres |> filter(type == "optStop") |> arrange(rmseBump2) |> slice(1:5) |> select(c(18:20, 10:14), rmseBump2) |> round(2) |> print()
```



# Three empirical p-curves

## "Sotola"

### Perfect set (no p-hacking, real effects)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_perfect"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV perfect")
simres |> filter(condition == "multDV_perfect") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```

### H0 set (no p-hacking)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_H0"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV H0")
simres |> filter(condition == "multDV_H0") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```

### multDV realistic set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_realistic"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV realistic")
simres |> filter(condition == "multDV_realistic") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```

### multDV worst set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_worst"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV worst")
simres |> filter(condition == "multDV_worst") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```

### optStop realistic set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_realistic"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop realistic")
simres |> filter(condition == "optStop_realistic") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```

### optStop worst set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_worst"), poriginal = pcurves[pcurves$dataset == "sotola", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop worst")
simres |> filter(condition == "optStop_worst") |> arrange(rmseSotola) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSotola) |> round(3) |> print()
```



## "Wetzels"

### Perfect set (no p-hacking, real effects)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_perfect"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV perfect")
simres |> filter(condition == "multDV_perfect") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```

### H0 set (no p-hacking)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_H0"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV H0")
simres |> filter(condition == "multDV_H0") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```

### multDV realistic set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_realistic"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV realistic")
simres |> filter(condition == "multDV_realistic") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```

### multDV worst set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_worst"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV worst")
simres |> filter(condition == "multDV_worst") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```

### optStop realistic set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_realistic"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop realistic")
simres |> filter(condition == "optStop_realistic") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```

### optStop worst set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_worst"), poriginal = pcurves[pcurves$dataset == "wetzels", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop worst")
simres |> filter(condition == "optStop_worst") |> arrange(rmseWetzels) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseWetzels) |> round(3) |> print()
```



## "Simonsohn"

### Perfect set (no p-hacking, real effects)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_perfect"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV perfect")
simres |> filter(condition == "multDV_perfect") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```

### H0 set (no p-hacking)
```{r}
plot_pcurves(simres |> filter(condition == "multDV_H0"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV H0")
simres |> filter(condition == "multDV_H0") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```

### multDV realistic set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_realistic"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV realistic")
simres |> filter(condition == "multDV_realistic") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```

### multDV worst set
```{r}
plot_pcurves(simres |> filter(condition == "multDV_worst"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola multDV worst")
simres |> filter(condition == "multDV_worst") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```

### optStop realistic set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_realistic"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop realistic")
simres |> filter(condition == "optStop_realistic") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```

### optStop worst set
```{r}
plot_pcurves(simres |> filter(condition == "optStop_worst"), poriginal = pcurves[pcurves$dataset == "simonsohn", paste0("p", 1:5)], n_best=10) + ggtitle("Sotola optStop worst")
simres |> filter(condition == "optStop_worst") |> arrange(rmseSimonsohn) |> slice(1:5) |> select(c(1:9, 18:20, 10:14), rmseSimonsohn) |> round(3) |> print()
```
